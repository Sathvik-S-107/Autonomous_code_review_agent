import pytest
from fastapi.testclient import TestClient
from unittest.mock import patch
from app.main import app

client = TestClient(app)


@pytest.fixture
def sample_payload():
    return {
        "repo_url": "https://github.com/octocat/Hello-World",
        "pr_number": 1
    }


def test_health():
    r = client.get("/api/health")
    assert r.status_code == 200
    assert r.json()["status"] == "ok"


@patch("app.api.endpoints.analyze_pr_task.apply_async")
def test_submit_analysis(mock_apply, sample_payload):
    class DummyTask:
        id = "test-task-id"

    mock_apply.return_value = DummyTask()
    r = client.post("/api/analyze-pr", json=sample_payload)

    assert r.status_code == 202
    data = r.json()

    assert data["task_id"] == "test-task-id"
    assert data["status"] == "pending"
